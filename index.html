<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dorsz AI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg:#0f0f0f;--sidebar:#161616;--input:#1e1e1e;--msg:#1a1a1a;
      --text:#e8e8e8;--dim:#888;--accent:#4285f4;--accent2:#34a853;
      --voice:#ea4335;--purple:#a855f7;--border:rgba(255,255,255,0.08);
      --sidebar-w:260px;--sidebar-min:60px;
    }
    body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden}
    
    /* SIDEBAR */
    #sidebar{width:var(--sidebar-w);background:var(--sidebar);padding:10px;display:flex;flex-direction:column;transition:width .3s;overflow:hidden;border-right:1px solid var(--border)}
    #sidebar.collapsed{width:var(--sidebar-min)}
    #sidebar.collapsed .txt{display:none}
    #sidebar.collapsed .mode-tab span{display:none}
    #sidebar.collapsed .history-item span{display:none}
    #sidebar.collapsed .sidebar-btn span{display:none}
    #sidebar.collapsed .collapse-btn i{transform:rotate(180deg)}
    
    .collapse-btn{width:100%;padding:10px;background:none;border:none;color:var(--dim);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;border-radius:8px;margin-bottom:8px;transition:.2s}
    .collapse-btn:hover{background:rgba(255,255,255,0.1);color:var(--text)}
    .collapse-btn i{transition:transform .3s}
    
    .new-chat{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:none;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:10px;font-size:14px;transition:.2s}
    .new-chat:hover{background:rgba(255,255,255,0.08);border-color:var(--accent)}
    
    .mode-tabs{display:flex;gap:4px;margin-top:12px;padding:4px;background:rgba(0,0,0,0.3);border-radius:10px}
    .mode-tab{flex:1;padding:10px 8px;border:none;border-radius:8px;background:none;color:var(--dim);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;gap:6px;transition:.2s}
    .mode-tab:hover{color:var(--text)}
    .mode-tab.active{background:var(--input);color:var(--accent)}
    .mode-tab.active.image{color:var(--purple)}
    
    #history{flex:1;overflow-y:auto;margin-top:12px}
    .history-item{padding:10px 12px;border-radius:8px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:8px;margin-bottom:2px;transition:.2s}
    .history-item:hover{background:rgba(255,255,255,0.06)}
    .history-item.active{background:rgba(255,255,255,0.1)}
    .history-item i{opacity:.5;font-size:12px}
    
    .sidebar-bottom{border-top:1px solid var(--border);padding-top:8px;margin-top:8px}
    .sidebar-btn{width:100%;padding:10px 12px;border:none;border-radius:8px;background:none;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:10px;font-size:13px;transition:.2s}
    .sidebar-btn:hover{background:rgba(255,255,255,0.06)}
    
    /* MAIN */
    #main{flex:1;display:flex;flex-direction:column;min-width:0}
    
    #topbar{height:50px;padding:0 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
    #topbar button{background:none;border:none;color:var(--text);cursor:pointer;padding:8px;border-radius:6px;font-size:16px}
    #topbar button:hover{background:rgba(255,255,255,0.08)}
    #modeIndicator{font-weight:600;font-size:16px;display:flex;align-items:center;gap:8px}
    #modeIndicator.image{color:var(--purple)}
    
    /* WELCOME */
    #welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px}
    #welcome.hidden{display:none}
    .logo{font-size:72px;margin-bottom:16px}
    #welcome h1{font-size:32px;margin-bottom:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    #welcome p{color:var(--dim);margin-bottom:24px}
    .prompts{display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:500px}
    .prompt{padding:14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-size:13px;transition:.2s}
    .prompt:hover{background:rgba(255,255,255,0.08);border-color:var(--accent)}
    .prompt i{margin-right:8px;color:var(--accent)}
    .prompt.image i{color:var(--purple)}
    
    /* CHAT */
    #chat{flex:1;overflow-y:auto;display:none;padding:0}
    #chat.active{display:block}
    .msg{padding:24px 20px}
    .msg.user{background:var(--bg)}
    .msg.assistant{background:var(--msg)}
    .msg-inner{max-width:800px;margin:0 auto;display:flex;gap:16px}
    .avatar{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
    .avatar.user{background:var(--accent)}
    .avatar.assistant{background:var(--accent2)}
    .avatar.assistant.image{background:var(--purple)}
    .msg-text{flex:1;line-height:1.75;overflow-wrap:break-word}
    .msg-text pre{background:#000;padding:16px;border-radius:8px;overflow-x:auto;margin:12px 0;position:relative}
    .msg-text code{font-family:'Consolas',monospace;font-size:14px}
    .msg-text :not(pre)>code{background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px}
    .copy-btn{position:absolute;top:8px;right:8px;padding:4px 10px;background:rgba(255,255,255,0.1);border:none;border-radius:4px;color:#aaa;cursor:pointer;font-size:12px}
    .copy-btn:hover{background:rgba(255,255,255,0.2);color:white}
    
    .generated-image{max-width:100%;border-radius:12px;margin:12px 0;cursor:pointer}
    .image-actions{display:flex;gap:8px;margin-top:12px}
    .image-btn{padding:8px 14px;background:rgba(255,255,255,0.1);border:none;border-radius:8px;color:var(--text);cursor:pointer;font-size:13px;display:flex;align-items:center;gap:6px}
    .image-btn:hover{background:rgba(255,255,255,0.15)}
    
    .typing{display:inline-flex;gap:4px}
    .typing span{width:8px;height:8px;background:var(--text);border-radius:50%;animation:bounce 1.4s infinite}
    .typing span:nth-child(2){animation-delay:.2s}
    .typing span:nth-child(3){animation-delay:.4s}
    @keyframes bounce{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-8px);opacity:1}}
    
    /* INPUT */
    #input-area{padding:16px 20px 20px;border-top:1px solid var(--border)}
    .input-wrapper{max-width:800px;margin:0 auto}
    .input-box{display:flex;align-items:flex-end;background:var(--input);border:1px solid var(--border);border-radius:14px;padding:10px 14px;gap:8px;transition:.2s}
    .input-box:focus-within{border-color:var(--accent)}
    .input-box.image:focus-within{border-color:var(--purple)}
    
    #input{flex:1;background:none;border:none;outline:none;color:var(--text);font-size:15px;resize:none;max-height:150px;line-height:1.5;font-family:inherit}
    #input::placeholder{color:var(--dim)}
    
    .input-btn{background:none;border:none;color:var(--dim);cursor:pointer;padding:8px;border-radius:6px;font-size:18px;transition:.2s}
    .input-btn:hover{color:var(--text);background:rgba(255,255,255,0.08)}
    #voiceBtn.recording{color:var(--voice);animation:pulse 1.2s infinite}
    #send.active{color:var(--accent)}
    #send.active.image{color:var(--purple)}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    
    .input-info{text-align:center;font-size:11px;color:var(--dim);margin-top:10px}
    
    /* MODAL */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal.hidden{display:none}
    .modal-box{background:var(--sidebar);padding:28px;border-radius:16px;width:90%;max-width:400px;border:1px solid var(--border)}
    .modal-box h2{margin-bottom:20px;font-size:20px}
    .modal-box label{display:block;margin-bottom:6px;font-size:13px;color:var(--dim)}
    .modal-box input,.modal-box select{width:100%;padding:12px;margin-bottom:14px;background:var(--input);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px}
    .modal-box input:focus,.modal-box select:focus{outline:none;border-color:var(--accent)}
    .modal-box button{width:100%;padding:12px;background:var(--accent);border:none;border-radius:8px;color:white;font-weight:600;cursor:pointer;font-size:14px}
    .modal-box button:hover{opacity:.9}
    .modal-box button.secondary{background:none;border:1px solid var(--border);color:var(--text);margin-top:8px}
    
    /* LIGHTBOX */
    #lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:2000;cursor:zoom-out}
    #lightbox.show{display:flex}
    #lightbox img{max-width:95%;max-height:95%;border-radius:8px}
    
    /* SCROLLBAR */
    ::-webkit-scrollbar{width:6px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:3px}
    
    /* MOBILE */
    @media(max-width:768px){
      #sidebar{position:fixed;left:0;top:0;height:100%;z-index:100;transform:translateX(-100%);transition:transform .3s}
      #sidebar.open{transform:translateX(0)}
      #sidebar.collapsed{width:var(--sidebar-w)!important}
      .prompts{grid-template-columns:1fr}
      .collapse-btn{display:none}
    }
  </style>
</head>
<body>

<!-- SETTINGS MODAL -->
<div class="modal hidden" id="settingsModal">
  <div class="modal-box">
    <h2>‚öôÔ∏è Ustawienia</h2>
    <label>Twoje imiƒô:</label>
    <input type="text" id="userNameInput" placeholder="np. Kacper, Ania...">
    <label>Model Gemini:</label>
    <select id="modelSelect">
      <option value="gemini-1.5-flash">Gemini 1.5 Flash (szybki)</option>
      <option value="gemini-1.5-pro">Gemini 1.5 Pro (najmƒÖdrzejszy)</option>
      <option value="gemini-1.0-pro">Gemini 1.0 Pro (stabilny)</option>
    </select>
    <button onclick="saveSettings()">Zapisz</button>
    <button class="secondary" onclick="closeSettings()">Anuluj</button>
  </div>
</div>

<!-- LIGHTBOX -->
<div id="lightbox" onclick="this.classList.remove('show')">
  <img id="lightboxImg" src="">
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <button class="collapse-btn" onclick="toggleCollapse()">
    <i class="fas fa-chevron-left"></i>
  </button>
  
  <button class="new-chat" onclick="newChat()">
    <i class="fas fa-plus"></i><span class="txt">Nowy czat</span>
  </button>
  
  <div class="mode-tabs">
    <button class="mode-tab active" id="chatTab" onclick="setMode('chat')">
      <i class="fas fa-comment"></i><span>Czat</span>
    </button>
    <button class="mode-tab" id="imageTab" onclick="setMode('image')">
      <i class="fas fa-image"></i><span>Obrazy</span>
    </button>
  </div>
  
  <div id="history"></div>
  
  <div class="sidebar-bottom">
    <button class="sidebar-btn" onclick="clearAll()">
      <i class="fas fa-trash"></i><span class="txt">Wyczy≈õƒá</span>
    </button>
    <button class="sidebar-btn" onclick="openSettings()">
      <i class="fas fa-cog"></i><span class="txt">Ustawienia</span>
    </button>
  </div>
</div>

<!-- MAIN -->
<div id="main">
  <div id="topbar">
    <button onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <div id="modeIndicator">üêü Dorsz AI</div>
    <div style="width:40px"></div>
  </div>

  <div id="welcome">
    <div class="logo">üêü</div>
    <h1>Dorsz AI</h1>
    <p id="welcomeText">Jak mogƒô Ci dzisiaj pom√≥c?</p>
    <div class="prompts" id="promptsContainer"></div>
  </div>

  <div id="chat"></div>

  <div id="input-area">
    <div class="input-wrapper">
      <div class="input-box" id="inputBox">
        <textarea id="input" rows="1" placeholder="Napisz wiadomo≈õƒá lub u≈ºyj mikrofonu..."></textarea>
        <button class="input-btn" id="voiceBtn" onclick="toggleVoice()" title="M√≥w g≈Çosem">
          <i class="fas fa-microphone"></i>
        </button>
        <button class="input-btn" id="send" onclick="send()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
      <div class="input-info" id="inputInfo">Dorsz AI ‚Ä¢ Google Gemini ‚Ä¢ Enter = wy≈õlij ‚Ä¢ üé§ M√≥w bez przerywania</div>
    </div>
  </div>
</div>

<script>
// ========== KONFIGURACJA ==========
const API_KEY = 'AIzaSyAUhMzc40JclNn9Ndw5OwhBrK4DCmiaZFY';
const IMAGE_API = 'https://image.pollinations.ai/prompt/';

let userName = localStorage.getItem('dorsz_name') || '';
let model = localStorage.getItem('dorsz_model') || 'gemini-1.5-flash';
let currentMode = 'chat';
let messages = [];
let chats = JSON.parse(localStorage.getItem('dorsz_chats') || '[]');
let currentChat = null;
let generating = false;

// Voice
let recognition = null;
let isRecording = false;
let voiceText = '';
let lastSpeechTime = 0;

// Prompts
const CHAT_PROMPTS = [
  {icon:'fa-code', text:'Napisz kod w JavaScript'},
  {icon:'fa-lightbulb', text:'Daj mi kreatywny pomys≈Ç'},
  {icon:'fa-book', text:'Wyja≈õnij mi co≈õ prostymi s≈Çowami'},
  {icon:'fa-bug', text:'Pom√≥≈º mi naprawiƒá b≈ÇƒÖd'}
];
const IMAGE_PROMPTS = [
  {icon:'fa-mountain', text:'Zach√≥d s≈Ço≈Ñca nad g√≥rami'},
  {icon:'fa-robot', text:'Futurystyczny robot cyberpunk'},
  {icon:'fa-cat', text:'S≈Çodki kot w kosmosie'},
  {icon:'fa-city', text:'Miasto przysz≈Ço≈õci nocƒÖ'}
];

// ========== INIT ==========
function init() {
  document.getElementById('userNameInput').value = userName;
  document.getElementById('modelSelect').value = model;
  
  if (localStorage.getItem('dorsz_collapsed') === 'true') {
    document.getElementById('sidebar').classList.add('collapsed');
  }
  
  updateWelcome();
  updateModeUI();
  renderHistory();
  initVoice();
  
  const input = document.getElementById('input');
  input.addEventListener('input', resize);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });
}

function updateWelcome() {
  const text = userName ? `Cze≈õƒá ${userName}! Jak mogƒô Ci pom√≥c?` : 'Jak mogƒô Ci dzisiaj pom√≥c?';
  document.getElementById('welcomeText').textContent = text;
}

function getSystemPrompt() {
  const name = userName ? `Zwracaj siƒô do u≈ºytkownika: ${userName}. ` : '';
  return `Jeste≈õ Dorsz AI - pomocny, inteligentny asystent. ${name}Odpowiadaj po polsku. Formatuj kod w blokach. BƒÖd≈∫ konkretny i pomocny.`;
}

// ========== VOICE - IDEALNIE DZIA≈ÅA ==========
function initVoice() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    document.getElementById('voiceBtn').style.display = 'none';
    return;
  }
  
  const SR = window.webkitSpeechRecognition || window.SpeechRecognition;
  recognition = new SR();
  recognition.lang = 'pl-PL';
  recognition.continuous = true;
  recognition.interimResults = true;
  
  recognition.onresult = (e) => {
    lastSpeechTime = Date.now();
    let final = voiceText;
    let interim = '';
    
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) {
        final += e.results[i][0].transcript + ' ';
        voiceText = final;
      } else {
        interim = e.results[i][0].transcript;
      }
    }
    
    document.getElementById('input').value = final + interim;
    resize();
  };
  
  recognition.onerror = (e) => {
    if (e.error === 'not-allowed') {
      alert('Zezw√≥l na mikrofon!');
      stopVoice();
    }
  };
  
  recognition.onend = () => {
    if (isRecording) {
      setTimeout(() => {
        if (isRecording) recognition.start();
      }, 100);
    }
  };
}

function toggleVoice() {
  if (!recognition) return alert('Brak obs≈Çugi mikrofonu');
  isRecording ? stopVoice() : startVoice();
}

function startVoice() {
  isRecording = true;
  voiceText = document.getElementById('input').value;
  lastSpeechTime = Date.now();
  document.getElementById('voiceBtn').classList.add('recording');
  document.getElementById('voiceBtn').innerHTML = '<i class="fas fa-stop"></i>';
  recognition.start();
}

function stopVoice() {
  isRecording = false;
  document.getElementById('voiceBtn').classList.remove('recording');
  document.getElementById('voiceBtn').innerHTML = '<i class="fas fa-microphone"></i>';
  try { recognition.stop(); } catch(e) {}
}

// ========== MODE ==========
function setMode(mode) {
  currentMode = mode;
  updateModeUI();
}

function updateModeUI() {
  const chatTab = document.getElementById('chatTab');
  const imageTab = document.getElementById('imageTab');
  const indicator = document.getElementById('modeIndicator');
  const inputBox = document.getElementById('inputBox');
  const send = document.getElementById('send');
  const info = document.getElementById('inputInfo');
  const input = document.getElementById('input');
  
  if (currentMode === 'chat') {
    chatTab.classList.add('active');
    chatTab.classList.remove('image');
    imageTab.classList.remove('active');
    indicator.textContent = 'üêü Dorsz AI';
    indicator.classList.remove('image');
    inputBox.classList.remove('image');
    send.classList.remove('image');
    input.placeholder = 'Napisz wiadomo≈õƒá...';
    info.textContent = 'Dorsz AI ‚Ä¢ Google Gemini ‚Ä¢ Enter = wy≈õlij';
    renderPrompts(CHAT_PROMPTS, false);
  } else {
    imageTab.classList.add('active');
    imageTab.classList.add('image');
    chatTab.classList.remove('active');
    indicator.textContent = 'üé® Dorsz Grafik';
    indicator.classList.add('image');
    inputBox.classList.add('image');
    send.classList.add('image');
    input.placeholder = 'Opisz obraz...';
    info.textContent = 'Dorsz Grafik ‚Ä¢ Pollinations AI ‚Ä¢ Darmowe obrazy';
    renderPrompts(IMAGE_PROMPTS, true);
  }
}

function renderPrompts(prompts, isImage) {
  const container = document.getElementById('promptsContainer');
  container.innerHTML = prompts.map(p => 
    `<div class="prompt ${isImage ? 'image' : ''}" onclick="use('${p.text}')">
      <i class="fas ${p.icon}"></i>${p.text}
    </div>`
  ).join('');
}

// ========== SEND ==========
function send() {
  const input = document.getElementById('input');
  const text = input.value.trim();
  if (!text || generating) return;
  
  if (isRecording) stopVoice();
  
  if (currentMode === 'image') {
    generateImage(text);
  } else {
    sendChat(text);
  }
}

function sendChat(text) {
  document.getElementById('welcome').classList.add('hidden');
  document.getElementById('chat').classList.add('active');
  
  messages.push({role: 'user', content: text});
  addMsg('user', text);
  
  document.getElementById('input').value = '';
  resize();
  
  generating = true;
  const typing = addTyping();
  
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY}`;
  
  const contents = [];
  
  // System prompt jako pierwsza wiadomo≈õƒá
  contents.push({
    role: 'user',
    parts: [{text: getSystemPrompt()}]
  });
  contents.push({
    role: 'model',
    parts: [{text: 'Rozumiem! Jestem Dorsz AI i chƒôtnie pomogƒô.'}]
  });
  
  // Historia + nowa wiadomo≈õƒá
  messages.forEach(m => {
    contents.push({
      role: m.role === 'user' ? 'user' : 'model',
      parts: [{text: m.content}]
    });
  });
  
  fetch(apiUrl, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      contents: contents,
      generationConfig: {
        temperature: 0.8,
        maxOutputTokens: 8192
      }
    })
  })
  .then(r => r.json())
  .then(data => {
    typing.remove();
    
    if (data.candidates && data.candidates[0]) {
      const reply = data.candidates[0].content.parts[0].text;
      messages.push({role: 'assistant', content: reply});
      addMsg('assistant', reply);
      saveChat();
    } else {
      addMsg('assistant', '‚ùå B≈ÇƒÖd: ' + (data.error?.message || 'Nieznany b≈ÇƒÖd'));
    }
  })
  .catch(err => {
    typing.remove();
    addMsg('assistant', '‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: ' + err.message);
  })
  .finally(() => {
    generating = false;
  });
}

function generateImage(prompt) {
  document.getElementById('welcome').classList.add('hidden');
  document.getElementById('chat').classList.add('active');
  
  messages.push({role: 'user', content: prompt});
  addMsg('user', prompt);
  
  document.getElementById('input').value = '';
  resize();
  
  generating = true;
  
  const loading = document.createElement('div');
  loading.className = 'msg assistant';
  loading.innerHTML = `<div class="msg-inner">
    <div class="avatar assistant image">üé®</div>
    <div class="msg-text"><div class="typing"><span></span><span></span><span></span></div> Generujƒô obraz...</div>
  </div>`;
  document.getElementById('chat').appendChild(loading);
  loading.scrollIntoView({behavior: 'smooth'});
  
  const imageUrl = IMAGE_API + encodeURIComponent(prompt) + '?width=1024&height=1024&nologo=true';
  
  const img = new Image();
  img.onload = () => {
    loading.remove();
    const greeting = userName ? `${userName}, oto` : 'Oto';
    const html = `<p>${greeting} Tw√≥j obraz:</p>
      <img src="${imageUrl}" class="generated-image" onclick="document.getElementById('lightboxImg').src='${imageUrl}';document.getElementById('lightbox').classList.add('show')">
      <div class="image-actions">
        <button class="image-btn" onclick="window.open('${imageUrl}')"><i class="fas fa-external-link-alt"></i> Otw√≥rz</button>
        <button class="image-btn" onclick="downloadImg('${imageUrl}')"><i class="fas fa-download"></i> Pobierz</button>
      </div>`;
    messages.push({role: 'assistant', content: '[Obraz: ' + prompt + ']'});
    addMsg('assistant', html, true);
    saveChat();
    generating = false;
  };
  img.onerror = () => {
    loading.remove();
    addMsg('assistant', '‚ùå Nie uda≈Ço siƒô wygenerowaƒá obrazu');
    generating = false;
  };
  img.src = imageUrl;
}

function downloadImg(url) {
  fetch(url).then(r => r.blob()).then(blob => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'dorsz-ai-image.png';
    a.click();
  });
}

// ========== MESSAGES ==========
function addMsg(role, content, isRaw) {
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  
  const avatar = role === 'user' ? 'üë§' : 'üêü';
  const avatarClass = role + (currentMode === 'image' && role === 'assistant' ? ' image' : '');
  
  const formatted = isRaw ? content : formatText(content);
  
  div.innerHTML = `<div class="msg-inner">
    <div class="avatar ${avatarClass}">${avatar}</div>
    <div class="msg-text">${formatted}</div>
  </div>`;
  
  document.getElementById('chat').appendChild(div);
  div.scrollIntoView({behavior: 'smooth'});
  
  // Copy buttons
  div.querySelectorAll('pre').forEach(pre => {
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.innerHTML = '<i class="fas fa-copy"></i> Kopiuj';
    btn.onclick = () => {
      navigator.clipboard.writeText(pre.querySelector('code').textContent);
      btn.innerHTML = '<i class="fas fa-check"></i> OK!';
      setTimeout(() => btn.innerHTML = '<i class="fas fa-copy"></i> Kopiuj', 2000);
    };
    pre.appendChild(btn);
  });
  
  return div;
}

function addTyping() {
  const div = document.createElement('div');
  div.className = 'msg assistant';
  div.innerHTML = `<div class="msg-inner">
    <div class="avatar assistant">üêü</div>
    <div class="msg-text"><div class="typing"><span></span><span></span><span></span></div></div>
  </div>`;
  document.getElementById('chat').appendChild(div);
  div.scrollIntoView({behavior: 'smooth'});
  return div;
}

function formatText(text) {
  if (!text) return '';
  text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (m, lang, code) => 
    `<pre><code class="language-${lang}">${code.trim()}</code></pre>`
  );
  text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
  text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/\n/g, '<br>');
  return text;
}

// ========== HISTORY ==========
function saveChat() {
  if (!messages.length) return;
  
  const title = messages[0].content.substring(0, 30);
  const data = {title, messages: messages.slice(), mode: currentMode, date: Date.now()};
  
  if (currentChat !== null) {
    chats[currentChat] = data;
  } else {
    currentChat = chats.length;
    chats.push(data);
  }
  
  if (chats.length > 50) chats = chats.slice(-50);
  localStorage.setItem('dorsz_chats', JSON.stringify(chats));
  renderHistory();
}

function loadChat(i) {
  currentChat = i;
  messages = chats[i].messages.slice();
  currentMode = chats[i].mode || 'chat';
  updateModeUI();
  
  document.getElementById('welcome').classList.add('hidden');
  document.getElementById('chat').classList.add('active');
  document.getElementById('chat').innerHTML = '';
  
  messages.forEach(m => addMsg(m.role, m.content));
  renderHistory();
  closeSidebar();
}

function renderHistory() {
  const el = document.getElementById('history');
  el.innerHTML = '';
  
  for (let i = chats.length - 1; i >= 0; i--) {
    const c = chats[i];
    const icon = c.mode === 'image' ? 'fa-image' : 'fa-comment';
    const div = document.createElement('div');
    div.className = 'history-item' + (i === currentChat ? ' active' : '');
    div.innerHTML = `<i class="fas ${icon}"></i><span>${escapeHtml(c.title)}</span>`;
    div.onclick = () => loadChat(i);
    el.appendChild(div);
  }
}

function newChat() {
  currentChat = null;
  messages = [];
  document.getElementById('chat').innerHTML = '';
  document.getElementById('chat').classList.remove('active');
  document.getElementById('welcome').classList.remove('hidden');
  renderHistory();
  closeSidebar();
}

function clearAll() {
  if (!confirm('UsunƒÖƒá ca≈ÇƒÖ historiƒô?')) return;
  chats = [];
  localStorage.removeItem('dorsz_chats');
  newChat();
}

// ========== SETTINGS ==========
function openSettings() {
  document.getElementById('userNameInput').value = userName;
  document.getElementById('modelSelect').value = model;
  document.getElementById('settingsModal').classList.remove('hidden');
}

function closeSettings() {
  document.getElementById('settingsModal').classList.add('hidden');
}

function saveSettings() {
  userName = document.getElementById('userNameInput').value.trim();
  model = document.getElementById('modelSelect').value;
  localStorage.setItem('dorsz_name', userName);
  localStorage.setItem('dorsz_model', model);
  updateWelcome();
  closeSettings();
}

// ========== UI ==========
function resize() {
  const input = document.getElementById('input');
  input.style.height = 'auto';
  input.style.height = Math.min(input.scrollHeight, 150) + 'px';
  
  const hasText = input.value.trim();
  document.getElementById('send').classList.toggle('active', hasText);
}

function toggleCollapse() {
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('collapsed');
  localStorage.setItem('dorsz_collapsed', sidebar.classList.contains('collapsed'));
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
}

function use(text) {
  document.getElementById('input').value = text;
  resize();
  document.getElementById('input').focus();
}

function escapeHtml(text) {
  return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeSettings();
    document.getElementById('lightbox').classList.remove('show');
    if (isRecording) stopVoice();
  }
});

init();
</script>
</body>
</html>
