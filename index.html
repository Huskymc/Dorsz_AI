<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dorsz AI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Styl pozostaje bez zmian dla czytelno≈õci odpowiedzi - u≈ºyj tego samego CSS co wcze≈õniej */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root { --bg-main: #343541; --bg-sidebar: #202123; --bg-input: #40414f; --bg-msg-ai: #444654; --text: #ececf1; --text-dim: #8e8ea0; --accent: #19c37d; --accent-image: #a855f7; --border: rgba(255,255,255,0.1); --sidebar-width: 260px; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg-main); color: var(--text); height: 100vh; display: flex; }
    #sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); padding: 8px; display: flex; flex-direction: column; transition: width 0.3s; overflow: hidden; }
    #sidebar.collapsed { width: 60px; }
    #sidebar.collapsed span, #sidebar.collapsed .txt { display: none; }
    .new-chat { display: flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: none; color: var(--text); cursor: pointer; margin-bottom: 10px; }
    .mode-tabs { display: flex; gap: 4px; padding: 4px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 10px; }
    .mode-tab { flex: 1; padding: 8px; border: none; border-radius: 6px; background: none; color: var(--text-dim); cursor: pointer; }
    .mode-tab.active { background: var(--bg-input); color: var(--text); }
    #history { flex: 1; overflow-y: auto; }
    .history-item { padding: 10px; border-radius: 8px; cursor: pointer; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .history-item:hover { background: rgba(255,255,255,0.1); }
    #main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    #topbar { height: 48px; padding: 0 16px; display: flex; align-items: center; border-bottom: 1px solid var(--border); justify-content: space-between; }
    #welcome { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    #welcome.hidden { display: none; }
    #chat { flex: 1; overflow-y: auto; display: none; padding-bottom: 20px; }
    #chat.active { display: block; }
    .msg { padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.1); }
    .msg.assistant { background: var(--bg-msg-ai); }
    .msg-inner { max-width: 800px; margin: 0 auto; display: flex; gap: 15px; }
    .avatar { width: 30px; height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .avatar.user { background: #5436da; }
    .avatar.assistant { background: var(--accent); }
    .msg-text { line-height: 1.6; flex: 1; }
    #input-area { padding: 20px; }
    .input-box { max-width: 800px; margin: 0 auto; background: var(--bg-input); border-radius: 12px; display: flex; padding: 10px; align-items: flex-end; }
    #input { flex: 1; background: none; border: none; color: white; resize: none; padding: 5px; outline: none; font-family: inherit; font-size: 16px; }
    #send { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 5px 10px; font-size: 20px; }
    .generated-image { max-width: 100%; border-radius: 8px; margin-top: 10px; }
  </style>
</head>
<body>

<div id="sidebar">
  <button class="new-chat" onclick="newChat()"><i class="fas fa-plus"></i><span class="txt">Nowy czat</span></button>
  <div class="mode-tabs">
    <button class="mode-tab active" id="chatTab" onclick="setMode('chat')">Czat</button>
    <button class="mode-tab" id="imageTab" onclick="setMode('image')">Obrazy</button>
  </div>
  <div id="history"></div>
</div>

<div id="main">
  <div id="topbar">
    <span>üêü Dorsz AI</span>
    <button onclick="openSettings()" style="background:none; border:none; color:white; cursor:pointer;"><i class="fas fa-cog"></i></button>
  </div>

  <div id="welcome">
    <div style="font-size: 50px;">üêü</div>
    <h1>Dorsz AI</h1>
    <p>Wklej sw√≥j klucz API w ustawieniach, aby zaczƒÖƒá.</p>
  </div>

  <div id="chat"></div>

  <div id="input-area">
    <div class="input-box">
      <textarea id="input" rows="1" placeholder="Napisz co≈õ..." onkeydown="handleKey(event)"></textarea>
      <button id="send" onclick="send()"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<div id="settingsModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:100;">
  <div style="background:#202123; padding:30px; border-radius:15px; width:90%; max-width:400px;">
    <h3>Ustawienia</h3>
    <p style="font-size:12px; margin:10px 0;">Klucz API z Google AI Studio:</p>
    <input type="password" id="apiKeyInput" style="width:100%; padding:10px; margin-bottom:20px; background:#40414f; border:1px solid #555; color:white; border-radius:5px;">
    <button onclick="saveSettings()" style="width:100%; padding:10px; background:#19c37d; border:none; border-radius:5px; cursor:pointer;">Zapisz i Od≈õwie≈º</button>
  </div>
</div>

<script>
// Pobieranie klucza z localStorage lub Twojego domy≈õlnego
var API_KEY = localStorage.getItem('dorsz_api_key') || 'AIzaSyAUhMzc40JclNn9Ndw5OwhBrK4DCmiaZFY';
var currentMode = 'chat';
var messages = [];

function init() {
  document.getElementById('apiKeyInput').value = API_KEY;
  // Wczytaj historiƒô z pamiƒôci
  const saved = JSON.parse(localStorage.getItem('dorsz_chats') || '[]');
  const historyDiv = document.getElementById('history');
  saved.forEach((c, i) => {
    const item = document.createElement('div');
    item.className = 'history-item';
    item.innerText = c.title;
    item.onclick = () => loadChat(i);
    historyDiv.appendChild(item);
  });
}

function setMode(mode) {
  currentMode = mode;
  document.getElementById('chatTab').classList.toggle('active', mode === 'chat');
  document.getElementById('imageTab').classList.toggle('active', mode === 'image');
}

function handleKey(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } }

async function send() {
  const input = document.getElementById('input');
  const text = input.value.trim();
  if(!text) return;

  document.getElementById('welcome').classList.add('hidden');
  document.getElementById('chat').classList.add('active');
  
  addMsg('user', text);
  input.value = '';
  
  const loading = addMsg('assistant', '<i>Dorsz my≈õli...</i>');

  if(currentMode === 'chat') {
    try {
      // Zmieniony endpoint na v1 (najbardziej stabilny dla Flash)
      const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          contents: [{ parts: [{ text: text }] }]
        })
      });

      const data = await response.json();
      
      if(data.error) {
        loading.querySelector('.msg-text').innerHTML = `<span style="color:#ff6b6b;">‚ùå B≈ÇƒÖd Google: ${data.error.message}</span>`;
        return;
      }

      const reply = data.candidates[0].content.parts[0].text;
      loading.querySelector('.msg-text').innerText = reply;
      saveToHistory(text, reply);

    } catch(err) {
      loading.querySelector('.msg-text').innerHTML = `<span style="color:#ff6b6b;">‚ùå B≈ÇƒÖd po≈ÇƒÖczenia. Sprawd≈∫ czy klucz API jest poprawny w ustawieniach.</span>`;
    }
  } else {
    // Tryb obrazu (Pollinations)
    const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(text)}?width=1024&height=1024&nologo=true`;
    loading.querySelector('.msg-text').innerHTML = `<img src="${imgUrl}" class="generated-image" onload="this.style.opacity=1">`;
  }
}

function addMsg(role, text) {
  const chat = document.getElementById('chat');
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = `<div class="msg-inner"><div class="avatar ${role}">${role==='user'?'U':'üêü'}</div><div class="msg-text">${text}</div></div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

function saveToHistory(q, a) {
  let chats = JSON.parse(localStorage.getItem('dorsz_chats') || '[]');
  chats.unshift({title: q.substring(0,20), q, a});
  localStorage.setItem('dorsz_chats', JSON.stringify(chats.slice(0,10)));
}

function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
function saveSettings() {
  const newKey = document.getElementById('apiKeyInput').value.trim();
  localStorage.setItem('dorsz_api_key', newKey);
  location.reload();
}
function newChat() { location.reload(); }

init();
</script>
</body>
</html>
